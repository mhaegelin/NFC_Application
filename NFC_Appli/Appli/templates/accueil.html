<!DOCTYPE HTML>
<!--
	Hyperspace by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		{% load static %}
		<title>Application eLOG</title>
		<meta charset="utf-8" />
		<!--<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="{% static "assets/css/main.css" %}"/>
		<link rel="stylesheet" href="{% static "assets/css/sumoselect.css" %}"/>
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<script src=" {% static 'assets/js/jquery.sumoselect.js' %}"></script>
	</head>
	<body>
		<!-- Sidebar -->
			<section id="sidebar">
				<div class="inner">
					<nav>
						<ul>
							<li><a href="#intro">Bonjour</a></li>
							<li><a href="#one">Gestion Utilisateurs</a></li>
							<li><a href="#two">Gestion Etudiants</a></li>
							<li><a href="#three">Gestion Promotions</a></li>
							<li><a href="#four">Gestion Groupes</a></li>
							<li><a href="#five">Gestion Fiches</a></li>
							<li><a href="{% url 'login' %}">Déconnexion</a></li>
						</ul>
					</nav>
				</div>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Intro -->
					<section id="intro" class="wrapper style1 fullscreen fade-up">
						<div class="inner">
							<h1>eLOG</h1>
							<p>Bonjour Administrateur!</p>
							<p>Vous êtes sur l'interface administrateur de eLOG.</p>
						</div>
					</section>

				<!-- One -->
					<section id="one" class="wrapper style3 fullscreen fade-up">
						<div class="inner">
							<h2>Gestion des utilisateurs</h2>
							<p>Selectionnez un utilisateur à gérer :</p>
							<div class="split style1">
								<section>
									<select id="listutil">
										<option value="default">#NoSelection#</option>
										{% for util in liste_util %}
										{% if util.username != 'Admin' %}
										<option value="{{ util.idutil }}">{{util.idutil}} {{ util.first_name }} {{ util.last_name }}</option>
										{% endif %}
										{% endfor %}
									</select>
									<br>
									<ul class="actions" align="right">
											<li><a class="button" onClick="empty_data();display_user_form();action_ajouter();" name="add_user" id="add_user">Ajouter</a></li>
											<li><a class="button special disabled" onClick="display_user_form();load_data();action_modify();" name="change_user" id="change_user">Modifier</a></li>
											<li><a class="button special disabled" onClick="del_user();" name="drop_user" id="drop_user">Supprimer</a></li>
									</ul>
   	  								 <div id="user_form" hidden="true">
									 <form method="post" action="/Appli/signup/">
										{% csrf_token %}
										<div class="split">
										<section>
										<div class="field">
											<label for="prenomutil">Prénom</label>
											<input type="text" name="prenomutil" id="prenomutil" />
										</div>
										</section>
										<section>
										<div class="field">
											<label for="nameutil">Nom de famille</label>
											<input type="text" name="nameutil" id="nameutil" />
										</div>
										</section>
										</div>
										<div class="split">
										<section>
										<div class="field">
											<label for="username">Nom d'utilisateur</label>
											<input type="text" name="username" id="username" />
										</div>
										</section>
										<section>
										<div class="field">
											<label for="mailutil">Email</label>
											<input type="text" name="mailutil" id="mailutil" />
										</div>
										</section>
										</div>
										<table style="max-width:600px">
											<tr>
											<td style="vertical-align:bottom"><label for="tracenfc">Trace NFC</label></td>
											<td style="vertical-align:bottom"><input type="text" value="Press button to scan.." name="tracenfc" id="tracenfc" readonly/></td>
											<td><input type="hidden"  name="scanning" id="scanning" value="1">
												<div id="abortbutton" hidden="true"><input type="button" name="abort" id="abort" value="Annuler" onclick="Annuler();"></div>
												<div id="scanbutton"><input type="button" name="scan" id="scan" value="Scanner" onclick="Scanner();"></div>
											</td>
											</tr>
										</table>
										<ul class="actions" align="right">
											<li><a class="button" id="validation">Valider</a></li>
											<li><a class="button" onClick="hide_user_form();" id="annulation">Annuler</a></li>
										</ul>
										<script>
											function Annuler(){
												$("#scanning").val("0");
												$("#tracenfc").val("Press button to scan..");
											}
											function Scanner(){
												
												if ($("#scanning").val()=="1") {
												$.ajax({
												url: '/Appli/update_scanning/',
												data: {'stopscanning':0},
												dataType: 'json',
												success: function (data) {
														if (jQuery.isEmptyObject(data)){
														setTimeout(Scanner, 1000);
															$("#scanbutton").hide();
															$("#abortbutton").show();
															$("#tracenfc").val("Scanning..");
														}
														else{
															$("#tracenfc").val(data.tracenfc);
															$("#abortbutton").hide();
															$("#scanbutton").show();
														}
												}
												});
											}
											else{
												$("#scanning").val("1");
												$("#abortbutton").hide();
												$("#scanbutton").show();
												$.ajax({
												url: '/Appli/update_scanning/',
												data: {'stopscanning':1},
												dataType: 'json',
												success: function (data) {
												}
												});
											}
											}
										</script>
									</form>
									</div>
								</section>
							</div>
						</div>
						</section>
						<script>
						$("#listutil").change(function() {
						var utilname = $(this).val();
						var id = utilname.split(' ');
						
						if (id!="default") {
						$("#change_user").removeClass('button special disabled').addClass('button');
						$("#drop_user").removeClass('button special disabled').addClass('button');
						}
						else {
						$("#change_user").removeClass('button').addClass('button special disabled');
						$("#drop_user").removeClass('button').addClass('button special disabled');
						};
						});
						
						function display_user_form() {
						$("#user_form").show();
						$("#add_user").removeClass('button').addClass('button special disabled');
						$("#change_user").removeClass('button').addClass('button special disabled');
						$("#drop_user").removeClass('button').addClass('button special disabled');
						$("#listutil").prop('disabled', true);
						};
						
						function hide_user_form() {
						$("#user_form").hide();
						$("#add_user").removeClass('button special disabled').addClass('button');
						$("#change_user").removeClass('button').addClass('button special disabled');
						$("#drop_user").removeClass('button').addClass('button special disabled');
						$("#listutil").prop('disabled', false);
						$("#listutil").val('default').change();
						Annuler();
						};
						
						
						function load_data() {
							var utilname = $("#listutil").val();
							var id = utilname.split(' ');
							
							$.ajax({
							url: '/Appli/accueil/ajaxutil',
							data: {
							'id': id[0]
							},
							dataType: 'json',
							success: function (data) {
							$("#username").val(data.user_name);
							$("#prenomutil").val(data.first_name);
							$("#nameutil").val(data.last_name);
							$("#mailutil").val(data.mail);
							$("#tracenfc").val(data.tracenfc);
							}
							});
						}
						
						function empty_data() {
							$("#username").val('');
							$("#prenomutil").val('');
							$("#nameutil").val('');
							$("#mailutil").val('');
							$("#tracenfc").val('Press button to scan..');
						}
						
						function action_ajouter() {
							//change l'action du bouton valider suite à clic sur ajout
							$("#validation").unbind('click');
							$("#annulation").unbind('click');
							$("#listutil").val('default').change();
							$("#validation").bind('click', function(){
								//set your method - validation
								//alert('Validation -- ajout');
								var username = $("#username").val();
								var nameutil = $("#nameutil").val();
								var prenomutil = $("#prenomutil").val();
								var mailutil = $("#mailutil").val();
								var tracenfc = $("#tracenfc").val();
								//alert(username + nameutil + prenomutil + mailutil);
								$.ajax({
									url: '/Appli/accueil/adduser',
									data: {
									'username': username,
									'nameutil': nameutil,
									'prenomutil': prenomutil,
									'mailutil': mailutil,
									'tracenfc': tracenfc
									},
									dataType: 'json',
									success: function (data) {
									//Ajouter la donnee ds la liste select/option
									if (jQuery.isEmptyObject(data)){
										alert('Nom d\'utilisateur déjà pris!');
									}
									else {
                                    $("#listutil").append('<option value='+data.id+'>'+data.id+' '+data.first_name+' '+data.last_name+'</option>');
									hide_user_form();
									}
									}
								});
								});
							$("#annulation").bind('click', function(){
							});
						}
						
						function action_modify() {
							//change l'action du bouton valider suite à clic sur modifier
							$("#validation").unbind('click');
							$("#annulation").unbind('click');
							$("#validation").bind('click', function(){
								//set your method - validation
								//alert('Validation -- modifier');
								var username = $("#username").val();
								var nameutil = $("#nameutil").val();
								var prenomutil = $("#prenomutil").val();
								var mailutil = $("#mailutil").val();
								var tracenfc = $("#tracenfc").val();
							    var usertmp = $("#listutil").val();
								var id = usertmp.split(' ');
								
								$.ajax({
									url: '/Appli/accueil/changeuser',
									data: {
									'id': id[0],
									'username': username,
									'nameutil': nameutil,
									'prenomutil': prenomutil,
									'mailutil': mailutil
									},
									dataType: 'json',
									success: function (data) {
									//Ajouter la donnee ds la liste select/option
									if (jQuery.isEmptyObject(data)){
										alert('Nom d\'utilisateur déjà pris!');
									}
									else{
									$("#listutil option[value='"+data.id+"']").remove();
									$("#listutil").append('<option value='+data.id+'>'+data.id+' '+data.first_name+' '+data.last_name+'</option>');
									hide_user_form();									
									}
                                                                        
									}
								});
								});
							$("#annulation").bind('click', function(){
								//set your method - validation
								//alert('Annulation -- modifier');
                                                                
							});
						}
						
						function del_user() {
								var username = $("#listutil").val();
								var id = username.split(' ');
								//alert(id[0]);
								$.ajax({
									url: '/Appli/accueil/deleteuser',
									data: {
									'id': id[0]
									},
									dataType: 'json',
									success: function (data) {
									//Supprimer la donnee de la liste select/option
									$("#listutil option[value='"+id[0]+"']").remove();
                                                                        $("#listutil").val('default').change();
                                                                        hide_user_form();
									}
								});
						}
					</script>

				<!-- Two -->
					<section id="two" class="wrapper style1 fullscreen fade-up">
						<div class="inner">
							<h2>Gestion des etudiants</h2>
							<p>Selectionnez la promotion dont les étudiants sont à gérer : </p>
							<div class="split style1">
								<section>
									<select id="listpromo">
									<option value='default'>#Selectionner une promotion#</option>
									{% for promo in liste_promo %}
									<option> {{promo.idpromo}} {{promo.intitulepromo}}</option>
									{% endfor %}
									</select>
									<br>
									<ul class="actions" align="right">
											<li><a class="button special disabled" onClick="display_add_form();action_ajouter_etud();" name="add_etud" id="add_etud">Ajouter</a></li>
											<li><a class="button special disabled" onClick="display_change_form();action_change_etud();" name="change_etud" id="change_etud">Modifier</a></li>
											<li><a class="button special disabled" onClick="display_drop_form();action_del_etud();" name="drop_user" id="drop_etud">Supprimer</a></li>
									</ul>		
									<div id="listetud_form" hidden="true">
									<select id="listetud">
									<option>#Selectionner un etudiant#</option>			
									</select>
									</div>
									<form method="post" action="/Appli/accueil/">
										{% csrf_token %}
										<div id="etud_form" hidden="true">
										<div class="split">
										<section>
										<div class="field">
											<label for="name">Nom d'etudiant</label>
											<input type="text" name="name" id="name" />
										</div>
										</section>
										<section>
										<div class="field">
											<label for="prenom">Prenom etudiant</label>
											<input type="text" name="surname" id="surname" />
										</div>
										</section>
										</div>
										<div class="split">
										<section>
										<div class="field">
											<label for="prenom">Mail etudiant</label>
											<input type="text" name="mail" id="mail" />
										</div>
										</section>
										<section>
											<label for="groupes">Liste des groupes</label>
											<span id="listegp"><select id="listegroupes" name="listegroupes" multiple="multiple" style="border-radius:3px;height:2.75em;outline-color:orange;background-color:rgb(98,76,166);width:14.6em;">
											<!--{% for groupe in liste_groupe %}
											<option value="{{ groupe.idgroupe }}"> {{ groupe.idgroupe }} {{ groupe.intitulegroupe }}</option>
											{% endfor %}-->
											</select></span>
										</section>
										</div>
										<table style="max-width:600px">
											<tr>
											<td style="vertical-align:bottom"><label for="tracenfc">Trace NFC</label></td>
											<td style="vertical-align:bottom"><input type="text" value="Press button to scan.." name="tracenfcetud" id="tracenfcetud" readonly/></td>
											<td><input type="hidden"  name="scanningetud" id="scanningetud" value="1">
												<div id="abortbuttonetud" hidden="true"><input type="button" name="abortetud" id="abortetud" value="Annuler" onclick="AnnulerEtud();"></div>
												<div id="scanbuttonetud"><input type="button" name="scanetud" id="scanetud" value="Scanner" onclick="ScannerEtud();"></div>
											</td>
											</tr>
										</table>
										</div>
										<div id="etud_button" hidden="true">
										<ul class="actions" align="right">
											<li><a class="button" id="validationetud">Valider</a></li>
											<li><a onclick="hide_etud_form();empty_etud_form();" class="button">Annuler</a></li>
										</ul>
										</div>
									</form>
								</section>
							</div>
						</div>
					</section>
					<script>
					function AnnulerEtud(){
						$("#scanningetud").val("0");
						$("#tracenfcetud").val("Press button to scan..");
					}
					function ScannerEtud(){
						
						if ($("#scanningetud").val()=="1") {
						$.ajax({
						url: '/Appli/update_scanning/',
						data: {'stopscanning':0},
						dataType: 'json',
						success: function (data) {
								if (jQuery.isEmptyObject(data)){
								setTimeout(ScannerEtud, 1000);
									$("#scanbuttonetud").hide();
									$("#abortbuttonetud").show();
									$("#tracenfcetud").val("Scanning..");
								}
								else{
									$("#tracenfcetud").val(data.tracenfc);
									$("#abortbuttonetud").hide();
									$("#scanbuttonetud").show();
								}
						}
						});
					}
					else{
						$("#scanningetud").val("1");
						$("#abortbuttonetud").hide();
						$("#scanbuttonetud").show();
						$.ajax({
								url: '/Appli/update_scanning/',
								data: {'stopscanning':1},
								dataType: 'json',
								success: function (data) {
								}
								});
					}
					}
						
					$("#listetud").change(function () {
									        var username = $("#listetud option:selected").text();
											var id = username.split(' ');
											var tidpromo = $("#listpromo").val().split(' ');
											//alert(tidpromo);
											idpromo = tidpromo[0];
											//alert(idpromo);
											if (id[0]!="#Selectionner"){
											$("#validationetud").removeClass('button special disabled').addClass('button');
											$.ajax({
											url: '/Appli/accueil/ajaxetud',
											data: {
											  'id': id[0],
											  'idpromo': idpromo
											},
											dataType: 'json',
											success: function (data) {
											    $("#name").val(data.name);
											    $("#surname").val(data.surname);
											    $("#mail").val(data.mail);
											    $("#tracenfcetud").val(data.tracenfc);
											    for(var i=0; i<$("#listegroupes option").length ; i++){
												$('#listegroupes')[0].sumo.unSelectItem(i);
												}
												
												var obj = [];
												var items = '';
												$('#listegroupes option').each(function(i) {
												  obj.push($(this).text());
												  //$('#listegroupes')[0].sumo.unSelectItem(i);
												});
												for (var i = 0; i < obj.length; i++) {
												  items += ' ' + obj[i];
												  tab=obj[i].split(' ');
												  obj[i]=tab[0];
												};
												
												for (var i=0; i<$("#listegroupes option").length; i++){
													for (var j=0; j<data.groupes.length; j++){
															if (data.groupes[j].idgroupe==obj[i]){
																$('#listegroupes')[0].sumo.selectItem(i);
															}
													}
												}
												
												
												//alert('Change listetud');
												//var num = $("#listegroupes option").length;
												//var ids = $("#listegroupes option").val();
												//alert('num='+num);
												//alert('ids='+ids);
												//alert('data length='+data.groupes.length);
											    /*for (var i=0 ; i<data.groupes.length; i++){
												//alert(typeof data.groupes[i].idgroupe);
												//alert(data.groupes[i].idgroupe);
												$('#listegroupes')[0].sumo.selectItem(data.groupes[i].idgroupe-1);
												}*/
											}
										      });
										    }
										    else{
												empty_etud_form();
												$("#validationetud").removeClass('button').addClass('button special disabled');
											}
									    });
									    
					function empty_etud_form(){
						$("#name").val("");
						$("#surname").val("");
						$("#mail").val("");
						$("#tracenfcetud").val("Press button to scan..");
						for(var i=0; i<$("#listegroupes option").length ; i++){
						$('#listegroupes')[0].sumo.unSelectItem(i);
						}
					};
					
					
					$("#listpromo").change(function() {
						if ($("#listpromo").val() == "default"){
						$("#add_etud").removeClass('button').addClass('button special disabled');
						$("#change_etud").removeClass('button').addClass('button special disabled');
						$("#drop_etud").removeClass('button').addClass('button special disabled');
						}
						else{
						load_listetud_accueil();
						$("#add_etud").removeClass('button special disabled').addClass('button');
						$("#change_etud").removeClass('button special disabled').addClass('button');
						$("#drop_etud").removeClass('button special disabled').addClass('button');
					}
					});
					
					function display_add_form() { // Affiche formulaire ajout etudiant
					$("#listetud_form").hide();
					$("#etud_button").show();
					$("#etud_form").show();
					$("#add_etud").removeClass('button').addClass('button special disabled');
					$("#change_etud").removeClass('button').addClass('button special disabled');
					$("#drop_etud").removeClass('button').addClass('button special disabled');
					$("#validationetud").removeClass('button special disabled').addClass('button');
					$("#listpromo").prop('disabled', true);
					};
					
					function display_change_form() { // Affiche formulaire changement etudiant
					$("#listetud_form").show();
					$("#etud_button").show();
					$("#etud_form").show();
					$("#add_etud").removeClass('button').addClass('button special disabled');
					$("#change_etud").removeClass('button').addClass('button special disabled');
					$("#drop_etud").removeClass('button').addClass('button special disabled');
					$("#listpromo").prop('disabled', true);
					};
					
					function hide_etud_form() { // Masquage du formulaire
					$("#listetud_form").hide();
					$("#etud_button").hide();
					$("#etud_form").hide();
					$("#add_etud").removeClass('button').addClass('button special disabled');
					$("#change_etud").removeClass('button').addClass('button special disabled');
					$("#drop_etud").removeClass('button').addClass('button special disabled');
					$("#listpromo").prop('disabled', false);
					$("#listpromo").val('default').change();
					AnnulerEtud();
					};
					
					function display_drop_form() { // Affiche formulaire suppression etudiant
						$("#listetud_form").show();
						$("#etud_button").show();
						$("#add_etud").removeClass('button').addClass('button special disabled');
						$("#change_etud").removeClass('button').addClass('button special disabled');
						$("#drop_etud").removeClass('button').addClass('button special disabled');
						$("#validationetud").removeClass('button').addClass('button special disabled');						
						$("#listpromo").prop('disabled', true);
					};
					
					
					function load_listetud_accueil() {
						
						var promo = $("#listpromo").val();
						var id = promo.split(' ');
						
						$.ajax({
							url: '/Appli/accueil/ajaxlistetud',
							data: {
								'id': id[0]
							},
							dataType: 'json',
							success: function (data) {
								//Supprimer les elements préalablement dans les select option
								$('#listetud')
								.find('option')
								.remove()
								.end();
								
								$("#listegroupespromo")[0].sumo.reload();
								
								
								listegps = eval(data.listegps);
								
								var num = listegps.length;
								
								for (var key in listegps) {
									$("#listegroupes")[0].sumo.add(listegps[key].input_idgroupe.toString()+' '+listegps[key].input_intitule.toString());
								}
								
								var cpt = $("#listegroupes option").length-num;
								
								for (var i=0 ; i < cpt; i++){
								$("#listegroupes")[0].sumo.remove(0);
							    }
							    								
								
								$("#listetud").append('<option value="default">#Selectionner un etudiant#</option>');
								listetud = eval(data.listetud);
								for (var key in listetud) {
									//alert(listetud[key].input_idetud);
									$("#listetud").append('<option value='+listetud[key].input_idetud+'>'+listetud[key].input_idetud + ' ' + listetud[key].input_prenometud
									+' ' + listetud[key].input_nometud+'</option>');
								}
							}
						});
					}
								
					function action_ajouter_etud() {
							//change l'action du bouton valider suite à clic sur ajout
							//$("#validationetud").removeClass('button').addClass('button special disabled');
							$("#validationetud").unbind('click');
							$("#validationetud").bind('click', function(){
								//set your method - validation
								//alert('Validation -- ajout');
								var etudnom = $("#name").val();
								var etudprenom = $("#surname").val();
								var etudmail = $("#mail").val();
								var etudtracenfc = $("#tracenfcetud").val();
								var etudgroupes = $("#listegroupes").val();
								var idpromo = $("#listpromo").val().split(' ');
								tab = []
								for(var i=0; i<etudgroupes.length; i++){
									inter = etudgroupes[i].split(' ');
									tab.push(inter[0]);
								}
								etudgroupes = JSON.stringify(tab);
								$.ajax({
									url: '/Appli/accueil/ajaxaddetud',
									data: {
									'etudnom': etudnom,
									'etudprenom': etudprenom,
									'etudmail': etudmail,
									'etudtracenfc': etudtracenfc,
									'etudgroupes': etudgroupes,
									'idpromo': idpromo[0]
									},
									dataType: 'json',
									success: function (data) {
                                    $("#listetud").append('<option value='+data.idetud+'>'+data.idetud+' '+data.prenom+' '+data.nom+'</option>');
									hide_etud_form();
									empty_etud_form();
									}
								});
								});
						}
						
						
					function action_change_etud() {
							$("#validationetud").removeClass('button').addClass('button special disabled');
							$("#validationetud").unbind('click');
							$("#validationetud").bind('click', function(){
								//set your method - validation
								//alert('Validation -- ajout');
								var etudnom = $("#name").val();
								var etudprenom = $("#surname").val();
								var etudmail = $("#mail").val();
								var etudtracenfc = $("#tracenfcetud").val();
								var etudgroupes = $("#listegroupes").val();
								var idetud = $("#listetud").val().split(' ');
								
								tab = []
								for(var i=0; i<etudgroupes.length; i++){
									inter = etudgroupes[i].split(' ');
									tab.push(inter[0]);
								}
								etudgroupes = JSON.stringify(tab);
								$.ajax({
									url: '/Appli/accueil/ajaxchangeetud',
									data: {
									'idetud': idetud[0],
									'etudnom': etudnom,
									'etudprenom': etudprenom,
									'etudmail': etudmail,
									'etudtracenfc': etudtracenfc,
									'etudgroupes': etudgroupes
									},
									dataType: 'json',
									success: function (data) {
                                    $("#listetud").append('<option value='+data.idetud+'>'+data.idetud+' '+data.prenom+' '+data.nom+'</option>');
									hide_etud_form();
									empty_etud_form();
									}
								});
								});
						}
						
						
					function action_del_etud() {
							$("#validationetud").unbind('click');
							$("#validationetud").bind('click', function(){
								var idetud = $("#listetud").val().split(' ');
								var idpromo = $("#listpromo").val().split(' ');
								$.ajax({
									url: '/Appli/accueil/ajaxdeletud',
									data: {
									'idetud': idetud[0],
									'idpromo': idpromo[0]
									},
									dataType: 'json',
									success: function (data) {
                                    $("#listetud option[value='"+data.idetud+"']").remove();
									empty_etud_form();
									}
								});
								});
						}
					</script>

				<!-- Three -->
					<section id="three" class="wrapper style3 fullscreen fade-up">
						<div class="inner">
							<h2>Gestion des Promotions</h2>
							<p>Selectionnez la promotion à gérer :</p>
							<span id="listegp"><select id="listpromo2" style="width: 30em;">
									<option value='default'>#Selectionner une promotion#</option>
									{% for promo in liste_promo %}
									<option value="{{ promo.idpromo }}"> {{promo.idpromo}} {{promo.intitulepromo}}</option>
									{% endfor %}
							</select>
							</span>
							<br>
							<ul class="actions">
							<li><a class="button" onClick="display_promo_form();action_add_promo();" name="add_promo" id="add_promo">Ajouter</a></li>
							<li><a class="button special disabled" onClick="display_promo_form();action_change_promo();" name="change_promo" id="change_promo">Modifier</a></li>
							<li><a class="button special disabled" onClick="action_del_promo();" name="drop_promo" id="drop_promo">Supprimer</a></li>
							</ul>
							<br>
							<div id="promo_form" hidden="true">
							<div class="field" style="width: 30em">
								<label for="intitule">Intitule promotion</label>
								<input type="text" name="intitulepromo" id="intitulepromo" />
							</div>
							<label for="listegroupespromo">Liste des groupes associés</label><br>
							<select id="listegroupespromo" name="listegroupespromo" multiple="multiple" style="border-radius:3px;height:2.75em;background-color:rgb(183,78,145);width:30em;">
							{% for groupe in liste_groupe %}
											<option value="{{ groupe.idgroupe }}"> {{ groupe.idgroupe }} {{ groupe.intitulegroupe }}</option>
							{% endfor %}
							</select>
							<br><br>
							<div id="promo_button">
							<ul class="actions">
								<li><a class="button" id="validationpromo">Valider</a></li>
								<li><a onclick="hide_promo_form();" class="button">Annuler</a></li>
							</ul>
							</div>
							</div>
						</div>
					</section>
					<script>
					function hide_promo_form() { // Masquage du formulaire
					$("#promo_form").hide();
					$("#add_promo").removeClass('button special disabled').addClass('button');
					$("#change_promo").removeClass('button').addClass('button special disabled');
					$("#drop_promo").removeClass('button').addClass('button special disabled');
					$("#listpromo2").prop('disabled', false);
					$("#listpromo2").val('default').change();
					};
					
					function display_promo_form() { // Affiche formulaire promo
						$("#promo_form").show();
						$("#add_promo").removeClass('button').addClass('button special disabled');
						$("#change_promo").removeClass('button').addClass('button special disabled');
						$("#drop_promo").removeClass('button').addClass('button special disabled');
						$("#listpromo2").prop('disabled', true);
					};
					
					function empty_promo_form() {
						$("#intitulepromo").val('');
						for(var i=0; i<$("#listegroupespromo option").length ; i++){
												$('#listegroupespromo')[0].sumo.unSelectItem(i);
												}
					}
					
					
					function action_del_promo() {
								var promo = $("#listpromo2").val().split(' ');
								var idpromo = promo[0];
								$.ajax({
									url: '/Appli/accueil/ajaxdelpromo',
									data: {
									'idpromo': idpromo
									},
									dataType: 'json',
									success: function (data) {
                                    $("#listpromo2 option[value='"+data.idpromo+"']").remove();
                                    $("#listpromo3 option[value='"+data.idpromo+"']").remove();
                                    $("#listpromo option[value='"+data.idpromo+"']").remove();
                                    $("#change_promo").removeClass('button').addClass('button special disabled');
									$("#drop_promo").removeClass('button').addClass('button special disabled');
									empty_promo_form();
									}
								});
					}
					
					function action_change_promo() {
								$("#add_promo").removeClass('button').addClass('button special disabled');
								$("#validationpromo").unbind('click');
								$("#validationpromo").bind('click', function(){
								var promo = $("#listpromo2").val().split(' ');
								var idpromo = promo[0];
								var intitule = $("#intitulepromo").val();
								var groupes = $("#listegroupespromo").val();
								groupes = JSON.stringify(groupes);
								$.ajax({
									url: '/Appli/accueil/ajaxchangepromo',
									data: {
									'idpromo': idpromo,
									'intitule':intitule,
									'groupes':groupes
									},
									dataType: 'json',
									success: function (data) {
								   $("#listpromo2 option:selected").text(data.idpromo+' '+data.intitule);
									hide_promo_form();
									empty_promo_form();
									}
								});
								});
					}
					
					function action_add_promo() {
								empty_promo_form();
								$("#listpromo2").val('default');
								$("#add_promo").removeClass('button').addClass('button special disabled');
								$("#validationpromo").unbind('click');
								$("#validationpromo").bind('click', function(){
								var intitule = $("#intitulepromo").val();
								var promogroupes = $("#listegroupespromo").val();
								var groupes = JSON.stringify(promogroupes);
								$.ajax({
									url: '/Appli/accueil/ajaxaddpromo',
									data: {
									'intitule': intitule,
									'groupes': groupes
									},
									dataType: 'json',
									success: function (data) {
                                   $("#listpromo2").append('<option value='+data.idpromo+'>'+data.idpromo+' '+data.intitule+'</option>');
                                   $("#listpromo3").append('<option value='+data.idpromo+'>'+data.idpromo+' '+data.intitule+'</option>');
								   $("#listpromo").append('<option value='+data.idpromo+'>'+data.idpromo+' '+data.intitule+'</option>');
									
									hide_promo_form();
									empty_promo_form();                                  
									}
								});
							});
							}		
					
					
					$("#listpromo2").change(function() {
						if ($("#listpromo2").val() == "default"){
						$("#add_promo").removeClass('button special disabled').addClass('button');
						$("#change_promo").removeClass('button').addClass('button special disabled');
						$("#drop_promo").removeClass('button').addClass('button special disabled');
						}
						else{
						load_listpromo_accueil();
						$("#add_promo").removeClass('button special disabled').addClass('button');
						$("#change_promo").removeClass('button special disabled').addClass('button');
						$("#drop_promo").removeClass('button special disabled').addClass('button');
					}
					});
					
					function load_listpromo_accueil() { 
						
						var promo = $("#listpromo2").val();
						var id = promo.split(' ');
						
						$.ajax({
							url: '/Appli/accueil/ajaxlistpromo',
							data: {
								'id': id[0]
							},
							dataType: 'json',
							success: function (data) {
								// MAJ des champs du formulaire promo
								$("#intitulepromo").val(data.intitule)
								//Deselectionner tous les groupes
								for(var i=0; i<$("#listegroupespromo option").length ; i++){
								$('#listegroupespromo')[0].sumo.unSelectItem(i);
								}
								
							    listgroupes=eval(data.listgroupes);
								for (var key in listgroupes){
								    $('#listegroupespromo')[0].sumo.selectItem(listgroupes[key].input_idgroupe-1);
								}
							}
						});
					}
					</script>
				<!-- Four -->
	<section id="four" class="wrapper style1 fullscreen fade-up">
			<div class="inner">
				<h2>Gestion des groupes</h2>
				<p>Selectionnez le groupe à gérer :</p>
				<span id="listegp"><select id="listgpe2" style="width: 30em;">
									<option value='default'>#Selectionner un groupe#</option>
									{% for gpe in liste_groupe %}
									<option> {{gpe.idgroupe}} {{gpe.intitulegroupe}}</option>
									{% endfor %}
							</select>
							</span>
							<br>
							<ul class="actions">
							<li><a class="button" onClick="display_groupe_form();" name="add_groupe" id="add_groupe">Ajouter</a></li>
							<li><a class="button special disabled" onClick="display_groupe_form();" name="change_groupe" id="change_groupe">Modifier</a></li>
							<li><a class="button special disabled" onClick="drop_group_action();" name="drop_groupe" id="drop_groupe">Supprimer</a></li>
							</ul>
							<br>
							<div id="groupe_form" hidden="true">
							<div class="field" style="width: 16em">
								<label for="intitule">Intitule groupe</label>
								<input type="text" name="intitule" id="intitule" />
							</div>
							<label for="listegroupespromo">Promotion associée</label><br>
							<select id="listpromo3" style="width: 16em;">
							<option value='default'>#Selectionner une promotion#</option>
							{% for promo in liste_promo %}
							<option> {{promo.idpromo}} {{promo.intitulepromo}}</option>
							{% endfor %}
							</select>
							<div id="groupe_button">
							<ul class="actions">
								<li><a class="button" id="validationgroupe">Valider</a></li>
								<li><a onclick="hide_groupe_form();" class="button">Annuler</a></li>
							</ul>
							</div>
							</div>
					</div>
		</section>
		<script>		
					function hide_groupe_form() { // Masquage du formulaire
					$("#groupe_form").hide()
					$("#add_groupe").removeClass('button special disabled').addClass('button');
					$("#change_groupe").removeClass('button').addClass('button special disabled');
					$("#drop_groupe").removeClass('button').addClass('button special disabled');
					$("#listgpe2").prop('disabled', false);
					$("#listgpe2").val('default').change();
					};
					
					function display_groupe_form() { // Affiche formulaire groupe
						$("#groupe_form").show();
						$("#add_groupe").removeClass('button').addClass('button special disabled');
						$("#change_groupe").removeClass('button').addClass('button special disabled');
						$("#drop_groupe").removeClass('button').addClass('button special disabled');
						$("#listgpe2").prop('disabled', true);
					};
					
					$("#listgpe2").change(function() {
						if ($("#listgpe2").val() == "default"){
						$("#add_groupe").removeClass('button special disabled').addClass('button');
						$("#change_groupe").removeClass('button').addClass('button special disabled');
						$("#drop_groupe").removeClass('button').addClass('button special disabled');
						}
						else{
						//load_groupe();
						$("#add_groupe").removeClass('button special disabled').addClass('button');
						$("#change_groupe").removeClass('button special disabled').addClass('button');
						$("#drop_groupe").removeClass('button special disabled').addClass('button');
					}
					});
					
					function empty_group_form() {
							$("#intitule").val('');
							$("#listepromo3").val('default').change();							
					}
					
					function drop_group_action() {
						var groupe = $("#listgpe2").val().split(' ');
						var idgroupe = groupe[0];
						$.ajax({
									url: '/Appli/accueil/ajaxdelgroupe',
									data: {
									'idgroupe': idgroupe
									},
									dataType: 'json',
									success: function (data) {
                                    $("#listegpe2").val('default').change();
                                    $("#listegpe2").remove();
									empty_group_form();
									}
								});
					};
					
					</script>
					<section id="five" class="wrapper style1 fullscreen fade-up">
						<div class="inner">
							<h2>Sélectionner une fiche</h2>
							<p>Veuillez choisir la fiche que vous souhaitez gérer :</p>
							<div class="split style1">
								<section>
									<select id="listfiche">
										<option value="default">#NoSelection#</option>
										{% for fiche in liste_fiche %}
										<option value="{{ fiche.idfiche }}">{{fiche.idfiche}}</option>
										{% endfor %}
									</select>
									<br>
									<hr>
   	  								<div id="fiche_form" hidden="true">
									<form method="post" action="{% url 'printfiche' %}">
										{% csrf_token %}
										<div class="vertical">
											<section>
												<div class="table-wrapper">
													<table>
														<thead>
															<tr>
																<th>Nom</th>
																<th>Prénom</th>
																<th>Présence</th>
															</tr>
														</thead>									
														<tbody id="listEtudFiche">
														</tbody>
													</table>
												</div>
											</section>
											<section>
												<div class="field">
													<input type="checkbox" id="validefiche" name="validefiche">
													<label for="validefiche">Valider</label>
												</div>
											</section>
										</div>
										<ul class="actions" align="right">
											<input type="hidden" id="print_fiche" name="print_fiche">
											<li><a class="button" onClick="action_modify_fiche();" name="change_fiche" id="change_fiche">Modifier</a></li>
											<li><input class="button" type="submit" value="Imprimer"></li>
											<li><a class="button" onClick="hide_fiche_form();" id="annulation">Retour</a></li>
										</ul>
									</form>
									</div>
								</section>
							</div>
						</div>
					</section>
					<script>
						$("#listfiche").change(function() {
						var id = $(this).val();
						
						if (id!="default") {
						display_fiche_form();
						load_listetud_fiche();
						}
						});
						
						function display_fiche_form() {
						$("#fiche_form").show();
						$("#listfiche").prop('disabled', true);
						$("#idfiche").prop('disabled', true);
						};
						
						function hide_fiche_form() {
						$("#fiche_form").hide();
						$("#listfiche").prop('disabled', false);
                        $("#listfiche").val('default').change();
						};
						
						
						function load_listetud_fiche() {
										
							var id = $("#listfiche").val();
							
							$.ajax({
								url: '/Appli/accueil/ajaxfiche',
								data: {
									'id': id
								},
								dataType: 'json',
								success: function (data) {
									$("#print_fiche").attr("value", data.id)
									if (data.valide == 0){
										$("#validefiche").prop('checked', false);
									}	
									else {
										$("#validefiche").prop('checked', true);
									}
									//Supprimer les elements préalablement dans le tableau
									$('#listEtudFiche')
									.find('tr')
									.remove()
									.end();
									listetudfiche = eval(data.listetudfiche);
									for (var key in listetudfiche) {
										$("#listEtudFiche").append('<tr> <td>' + listetudfiche[key].input_prenometud
										+'</td><td>' + listetudfiche[key].input_nometud+'</td> <td>' + listetudfiche[key].presence+'</td></tr>');
									}
								}
							});
						}
						
						
						function action_modify_fiche() {
							var id = $("#listfiche").val();
							if ($("#validefiche").is(":checked")) {
								var valide = 1;
							} else {
								var valide = 0;
							}
							
							$.ajax({
								url: '/Appli/accueil/changefiche',
								data: {
								'idFiche': id,
								'valide': valide
								},
								dataType: 'json',
								success: function (data) {
									$("#idfiche").val(data.id);
									if (data.valide == 0){
										$("#validefiche").prop('checked', false);
									}	
									else {
										$("#validefiche").prop('checked', true);
									}
								}
							});
						}
						
					</script>
			</div>
		<!-- Footer -->
			<footer id="footer" class="wrapper style1-alt">
				<div class="inner">
					<ul class="menu">
						<li>&copy; Untitled. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script>
				$(document).ready(function () {
						  $('#listegroupes').SumoSelect();
						  $('#listegroupespromo').SumoSelect();
					  });
			</script>
			
		<!-- Scripts -->
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="{% static "assets/js/main.js" %}"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
	</body>
</html>
